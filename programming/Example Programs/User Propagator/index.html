<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-programming docs-version-current docs-doc-page docs-doc-id-Example Programs/User Propagator" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">User Propagators | Online Z3 Guide</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io/z3guide/programming/Example Programs/User Propagator"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-programming-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-programming-current"><meta data-rh="true" property="og:title" content="User Propagators | Online Z3 Guide"><meta data-rh="true" name="description" content="User propagators allow implementing custom theory solvers outside of z3."><meta data-rh="true" property="og:description" content="User propagators allow implementing custom theory solvers outside of z3."><link data-rh="true" rel="icon" href="/z3guide/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://microsoft.github.io/z3guide/programming/Example Programs/User Propagator"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/z3guide/programming/Example Programs/User Propagator" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io/z3guide/programming/Example Programs/User Propagator" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://WELUFTGVJI-dsn.algolia.net" crossorigin="anonymous"><link rel="search" type="application/opensearchdescription+xml" title="Online Z3 Guide" href="/z3guide/opensearch.xml">




<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous">
<script src="/z3guide/coi-serviceworker.js" defer="defer"></script>
<script src="/z3guide/z3-built.js" defer="defer"></script><link rel="stylesheet" href="/z3guide/assets/css/styles.2df09eaf.css">
<script src="/z3guide/assets/js/runtime~main.3b2e0cec.js" defer="defer"></script>
<script src="/z3guide/assets/js/main.acb00959.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/z3guide/"><b class="navbar__title text--truncate">Z3 Guide</b></a><a class="navbar__item navbar__link" href="/z3guide/docs/logic/intro">SMTLIB Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/z3guide/programming/Z3 JavaScript Examples">Programming Z3</a><a class="navbar__item navbar__link" href="/z3guide/playground/Freeform Editing">Playground</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/microsoft/z3guide" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search (Command+K)"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20" aria-hidden="true"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/z3guide/programming/Z3 JavaScript Examples">Z3 JavaScript</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/z3guide/programming/Z3 Python - Readonly/Introduction">Z3 Python - Readonly</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/z3guide/programming/Example Programs/Cores and Satisfying Subsets">Example Programs</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/z3guide/programming/Example Programs/Cores and Satisfying Subsets">Cores and Satisfying Subsets</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/z3guide/programming/Example Programs/User Propagator">User Propagators</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/z3guide/programming/Example Programs/SPACER">SPACER</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/z3guide/programming/Example Programs/Formula Simplification">Formula Simplification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/z3guide/programming/Example Programs/MBQI">MBQI</a></li></ul></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/z3guide/programming/Parameters">Parameters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/z3guide/programming/API Reference">API Reference</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/z3guide/programming/Proof Logs">Proof Logs</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/z3guide/programming/Local Search">Local Search</a></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/z3guide/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Example Programs</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">User Propagators</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>User Propagators</h1></header><p>User propagators allow implementing custom theory solvers outside of z3.
The following example illustrates using propagators for solving over the
reflexive transitive closure (RTC) of a binary relation over a finite domain.
It is possible to axiomatize the reflexive transitive closure as a finite lookup table,
but the representation explodes (quadratically) when the size of the finite domain is large.</p>
<p>We represent the relation outside of z3. For sake of simplicity the example maintains the RTC
as a lookup table as well (so it does not scale as well as an an implicit representation of the RTC).
It also only implements a very basic set of rules for enforcing RTC over the finite domain.
We leave optimizations as a fun project you could explore while learning User Propagators.
For example, you can implement inference rules that check that the asserted binary relations
are consistent with the rules of transitivity.</p>
<div class="theme-admonition theme-admonition-warning admonition_xJq3 alert alert--warning"><div class="admonitionHeading_Gvgb"><span class="admonitionIcon_Rf37"><svg viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>warning</div><div class="admonitionContent_BuS1"><p>Programming decision procedures is generally not a trivial task. The UserPropagate API attempts to enable new decision procedures and keeping a relatively low barrier of entry. Nevertheless, even a simple theory that we are going to explore exhibits its own subtleties. Program user propagators at your own risk.</p></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="a-problem-instance">A Problem Instance<a href="#a-problem-instance" class="hash-link" aria-label="Direct link to A Problem Instance" title="Direct link to A Problem Instance">​</a></h2>
<p>We take a problem instance from a user GitHub question on how to scale reasoning with RTC.
The smaller example uses two relations <code>&lt;=Sort</code> and <code>&lt;=SortSyntax</code> that are reflexive and transitive
and they are defined over the finite enumeration sort <code>Sort</code>. We elide the declarations of the
two binary relations in the input and instead declare them outside of SMTLIB.
This allows us to declare the relations such that the propagator is notified whenever a new
predicate over <code>&lt;=Sort</code> or <code>&lt;=SortSyntax</code> is created.</p>
<div class="language-pyhon codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-pyhon codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">from z3 import *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">example = &quot;&quot;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(declare-datatypes () ((Sort</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(|SortInt| )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(|SortExp| )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(|SortKItem| )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(|SortKLabel| )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(|SortK| )</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">)))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;(declare-fun &lt;=Sort (Sort Sort) Bool)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;(declare-fun &lt;=SortSyntax (Sort Sort) Bool)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(declare-const |FreshVarSort_6_8_6_36_#KRewrite| Sort)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(declare-const |VarA| Sort)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(declare-const |VarB| Sort)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(declare-const |VarC| Sort)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(declare-datatypes() ((SolutionVariables (SolVars (|Sol_VarA| Sort) (|Sol_VarB| Sort) (|Sol_VarC| Sort) ))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(declare-datatypes() ((Solution (Sol (vars SolutionVariables) (|Sol_FreshVarSort_6_8_6_36_#KRewrite| Sort) ))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun theSolution () Solution (Sol (SolVars |VarA| |VarB| |VarC| ) |FreshVarSort_6_8_6_36_#KRewrite| ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun lt ((s1 Solution) (s2 Solution)) Bool (and true (&lt;=SortSyntax (|Sol_VarA| (vars s1)) (|Sol_VarA| (vars s2))) (&lt;=SortSyntax (|Sol_VarB| (vars s1)) (|Sol_VarB| (vars s2))) (&lt;=SortSyntax (|Sol_VarC| (vars s1)) (|Sol_VarC| (vars s2)))  (distinct (vars s1) (vars s2))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(assert (and true (distinct (|Sol_FreshVarSort_6_8_6_36_#KRewrite| theSolution) |SortKLabel|) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint4_SortExp| ((s Solution)) Bool (and true (&lt;=Sort (|Sol_VarA| (vars s)) |SortExp|) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint6_SortExp| ((s Solution)) Bool (and true (&lt;=Sort (|Sol_VarB| (vars s)) |SortExp|) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint3_SortExp| ((s Solution)) Bool (and true (&lt;=Sort |SortExp| |SortExp|) (|constraint4_SortExp| s) (|constraint6_SortExp| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint8_SortExp| ((s Solution)) Bool (and true (&lt;=Sort (|Sol_VarC| (vars s)) |SortExp|) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint2_(Sol_FreshVarSort_6_8_6_36_#KRewrite s)| ((s Solution)) Bool (and true (&lt;=Sort |SortExp| (|Sol_FreshVarSort_6_8_6_36_#KRewrite| s)) (|constraint3_SortExp| s) (|constraint8_SortExp| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint12_SortInt| ((s Solution)) Bool (and true (&lt;=Sort (|Sol_VarA| (vars s)) |SortInt|) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint14_SortInt| ((s Solution)) Bool (and true (&lt;=Sort (|Sol_VarB| (vars s)) |SortInt|) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint11_SortInt| ((s Solution)) Bool (and true (&lt;=Sort |SortInt| |SortInt|) (|constraint12_SortInt| s) (|constraint14_SortInt| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint16_SortInt| ((s Solution)) Bool (and true (&lt;=Sort (|Sol_VarC| (vars s)) |SortInt|) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint10_(Sol_FreshVarSort_6_8_6_36_#KRewrite s)| ((s Solution)) Bool (and true (&lt;=Sort |SortInt| (|Sol_FreshVarSort_6_8_6_36_#KRewrite| s)) (|constraint11_SortInt| s) (|constraint16_SortInt| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint1_Sort#RuleBody| ((s Solution)) Bool (and true (= (|Sol_FreshVarSort_6_8_6_36_#KRewrite| s) |SortK|) (|constraint2_(Sol_FreshVarSort_6_8_6_36_#KRewrite s)| s) (|constraint10_(Sol_FreshVarSort_6_8_6_36_#KRewrite s)| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint0_Sort#RuleContent| ((s Solution)) Bool (and true (|constraint1_Sort#RuleBody| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint21_SortExp| ((s Solution)) Bool (and true (&lt;=Sort |SortExp| |SortExp|) (|constraint6_SortExp| s) (|constraint8_SortExp| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint20_(Sol_FreshVarSort_6_8_6_36_#KRewrite s)| ((s Solution)) Bool (and true (&lt;=Sort |SortExp| (|Sol_FreshVarSort_6_8_6_36_#KRewrite| s)) (|constraint4_SortExp| s) (|constraint21_SortExp| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint19_Sort#RuleBody| ((s Solution)) Bool (and true (= (|Sol_FreshVarSort_6_8_6_36_#KRewrite| s) |SortK|) (|constraint20_(Sol_FreshVarSort_6_8_6_36_#KRewrite s)| s) (|constraint10_(Sol_FreshVarSort_6_8_6_36_#KRewrite s)| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun |constraint18_Sort#RuleContent| ((s Solution)) Bool (and true (|constraint19_Sort#RuleBody| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(define-fun amb0 ((s Solution)) Bool (or (|constraint0_Sort#RuleContent| s) (|constraint18_Sort#RuleContent| s) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(assert (amb0 theSolution))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;(assert (not (exists ((s Solution)) (and (lt theSolution s) (amb0 s) (distinct (|Sol_FreshVarSort_6_8_6_36_#KRewrite| s) |SortKLabel|) ))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(assert (not (exists ((var SolutionVariables) (s Sort)) (and (lt theSolution (Sol var s)) (amb0 (Sol var s)) (distinct s |SortKLabel|) ))))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(check-sat)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">(get-model)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;(assert (or false (distinct |VarA| |SortInt|) (distinct |VarB| |SortInt|) (distinct |VarC| |SortInt|) ))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">;(check-sat)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&quot;&quot;&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="propagate-functions">Propagate Functions<a href="#propagate-functions" class="hash-link" aria-label="Direct link to Propagate Functions" title="Direct link to Propagate Functions">​</a></h2>
<p>We can access the sort <code>Sort</code> from the SMTLIB input by declaring it as a <code>DatatypeSort</code>.
Then the two functions we did not define in the SMTLIB input are declared as <code>PropagateFunction</code>.
This declaration instructs z3 to invoke callbacks whenever a new term headed by the declared
function is introduced to the solver. It could be a term that is part of the input, or it could
be a term that is created dynamically using quantifier instantiation.</p>
<div><div class="buttons_Vg2Y"></div><div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="axiomatizing-rtcs">Axiomatizing RTCs<a href="#axiomatizing-rtcs" class="hash-link" aria-label="Direct link to Axiomatizing RTCs" title="Direct link to Axiomatizing RTCs">​</a></h2>
<div><div class="buttons_Vg2Y"></div><div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="union-find">Union Find<a href="#union-find" class="hash-link" aria-label="Direct link to Union Find" title="Direct link to Union Find">​</a></h2>
<p>We use a simple union find with support for tracking values.</p>
<div><div class="buttons_Vg2Y"></div><div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="finally-the-propagator">Finally, the propagator<a href="#finally-the-propagator" class="hash-link" aria-label="Direct link to Finally, the propagator" title="Direct link to Finally, the propagator">​</a></h2>
<p>It uses a good set of features exposed for user propagators.
It illustrates</p>
<ul>
<li>Instantiation of basic methods for backtracking and cloning</li>
<li>Registering terms to be tracked in callbacks</li>
<li>Callbacks for when terms are assigned fixed values</li>
<li>Callbacks for new equalities are detected by z3</li>
<li>Callbacks when new terms are created using <code>PropagateFunction</code></li>
<li>Callbacks when z3&#x27;s search is done case splitting</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tc-as-a-subclass">TC as a subclass<a href="#tc-as-a-subclass" class="hash-link" aria-label="Direct link to TC as a subclass" title="Direct link to TC as a subclass">​</a></h3>
<p>The <code>TC</code> solver is instantiated as a subclass of <code>UserPropagateBase</code>.
The subclass implements three virtual methods <code>push</code>, <code>pop</code>, and <code>fresh</code>.
It adds other optional callbacks for <code>fixed</code>, <code>final</code>, <code>eq</code> <code>created</code> and
initializes data-structures for tracking the reflexive transitive closure of
relations <code>&lt;=Sort</code> and <code>&lt;=SortSyntax</code>.</p>
<p>The push/pop callbacks are invoked when z3&#x27;s CDCL-based solver case splits and backtracks.
State changes within the scope of a push have to be reverted to an equivalent state.
It is not a requirement that the state be exactly the same, but it should preserve
satisfiability relative to the previous time it was in the same scope.
We restore state using functions that are pushed on a trail whenever some side-effect occurs within a scope.</p>
<p>The fresh callback is invoked when z3 creates a nested solver. The main use case for the nested solver is
z3&#x27;s model-based quantifier instantiation method, MBQI. MBQI uses the nested solver to check if a quantifier
is satisfied relative to a candidate model. The nested solver is opaque to the user propagator. Instead
it sees a new (unique) <code>context</code> object. For our use case the nested context shares the same tables for expressions
so we don&#x27;t have to maintain separate copies of expressions. If the nested solver is created using threads
(we are not enabling parallel solving for this example), the expression tables cannot be assumed the same
and TC would have to set up separate expressions for the new context.</p>
<p>The constructor of TC takes an optional solver <code>s</code> and an optional context <code>ctx</code>.
Initially it is created using a solver (and not a context).
Nested instances are created using a context (and not a solver).</p>
<div><div class="buttons_Vg2Y"></div><div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="handling-assignments-to-fixed-values">Handling assignments to fixed values<a href="#handling-assignments-to-fixed-values" class="hash-link" aria-label="Direct link to Handling assignments to fixed values" title="Direct link to Handling assignments to fixed values">​</a></h3>
<p>When <code>x</code> is fixed to value <code>v</code>, we check if it immediately
triggers a conflict. If it doesn&#x27;t we add it to a trail
that is checked on final. It is assumed that during final
<code>check_conflict</code> is conclusive (returns True) as all equatlities
are known between arguments to <code>&lt;=Sort</code> and <code>&lt;=SortSyntax</code>.</p>
<div><div class="buttons_Vg2Y"></div><div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="new-terms">New Terms<a href="#new-terms" class="hash-link" aria-label="Direct link to New Terms" title="Direct link to New Terms">​</a></h3>
<p>When a new term <code>t</code> is created using one of the <code>PropagateFunction</code> declarations we receive a callback.
It allows register <code>t</code> and its two arguments with z3. In return for registering these terms, z3 will
invoke <code>fixed</code> and <code>eq</code> callbacks when z3 infers a fixed value assignment or a new equality between
tracked terms.</p>
<div><div class="buttons_Vg2Y"></div><div></div></div>
<p>There is a subtle component in this callback: We need to register all constructors with the solver
otherwise, it could be that a constructor does not occur as argument of any
of the tracked predicates, but gets used by the solver and merged with
one of the arguments during search. If the constructor isn&#x27;t registered
<code>final()</code> cannot resolve the value associated with a <code>x</code> or <code>y</code>.</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="equality-callbacks">Equality callbacks<a href="#equality-callbacks" class="hash-link" aria-label="Direct link to Equality callbacks" title="Direct link to Equality callbacks">​</a></h3>
<p>Terms that have been registered using <code>self.add</code> are tracked by the solver.
The solver issues the equality callback when two registered terms are equated.
The number of equality callbacks for <em>N</em> terms that are equal is <em>N-1</em>, corresponding
to a spanning tree. So not all equalities are presented in callbacks and the client
can track equivalence classes by using a union-find data-structure as we are doing.</p>
<div><div class="buttons_Vg2Y"></div><div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="final-check">Final check<a href="#final-check" class="hash-link" aria-label="Direct link to Final check" title="Direct link to Final check">​</a></h3>
<div><div class="buttons_Vg2Y"></div><div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="using-the-user-propagator">Using the User Propagator<a href="#using-the-user-propagator" class="hash-link" aria-label="Direct link to Using the User Propagator" title="Direct link to Using the User Propagator">​</a></h2>
<div><div class="buttons_Vg2Y"></div><div></div></div></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/microsoft/z3guide/tree/main/website/docs-programming/03 - Example Programs/02 - User Propagator.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/z3guide/programming/Example Programs/Cores and Satisfying Subsets"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Cores and Satisfying Subsets</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/z3guide/programming/Example Programs/SPACER"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">SPACER</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#a-problem-instance" class="table-of-contents__link toc-highlight">A Problem Instance</a></li><li><a href="#propagate-functions" class="table-of-contents__link toc-highlight">Propagate Functions</a></li><li><a href="#axiomatizing-rtcs" class="table-of-contents__link toc-highlight">Axiomatizing RTCs</a></li><li><a href="#union-find" class="table-of-contents__link toc-highlight">Union Find</a></li><li><a href="#finally-the-propagator" class="table-of-contents__link toc-highlight">Finally, the propagator</a><ul><li><a href="#tc-as-a-subclass" class="table-of-contents__link toc-highlight">TC as a subclass</a></li><li><a href="#handling-assignments-to-fixed-values" class="table-of-contents__link toc-highlight">Handling assignments to fixed values</a></li><li><a href="#new-terms" class="table-of-contents__link toc-highlight">New Terms</a></li><li><a href="#equality-callbacks" class="table-of-contents__link toc-highlight">Equality callbacks</a></li><li><a href="#final-check" class="table-of-contents__link toc-highlight">Final check</a></li></ul></li><li><a href="#using-the-user-propagator" class="table-of-contents__link toc-highlight">Using the User Propagator</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More Z3</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://z3prover.github.io/papers/programmingz3.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Programming Z3 in Python<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/Z3Prover/z3" target="_blank" rel="noopener noreferrer" class="footer__link-item">Z3 on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a class="footer__link-item" href="/z3guide/Acknowledgments">Acknowledgments</a></li></ul></div><div class="col footer__col"><div class="footer__title">Z3 Material</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://z3prover.github.io/api/html/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">API</a></li><li class="footer__item"><a href="https://z3prover.github.io/slides" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slides<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/z3prover/z3/wiki" target="_blank" rel="noopener noreferrer" class="footer__link-item">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Stay Connected</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/microsoft/z3guide" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/RiSE_MSR" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.microsoft.com/en-us/research/group/research-software-engineering-rise/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RiSE @ MSR<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://go.microsoft.com/fwlink/?LinkId=521839" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy &amp; Cookies<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/copyright" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/trademarks/usage/general" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademarks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><a href="https://github.com/microsoft/z3guide/commit/fd5301679a7037e12c3119b0a30b5151f6d2c7ad" target="_blank" rel="noopener noreferrer">fd530167</a> | <a href="https://www.npmjs.com/package/z3-solver/v/4.15.1" target="_blank" rel="noopener noreferrer">z3-solver 4.15.1</a> | Copyright © 2025 Microsoft Corporation.</div></div></div></footer></div>
</body>
</html>