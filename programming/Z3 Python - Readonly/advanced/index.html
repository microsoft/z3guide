<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-programming docs-doc-id-Z3 Python - Readonly/advanced">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.1">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous">
<script src="/z3guide/coi-serviceworker.js" defer="defer"></script>
<script src="/z3guide/z3-built.js" defer="defer"></script><title data-rh="true">Advanced Topics | Online Z3 Guide</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:url" content="https://microsoft.github.io//z3guide/programming/Z3 Python - Readonly/advanced"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-programming-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-programming-current"><meta data-rh="true" property="og:title" content="Advanced Topics | Online Z3 Guide"><meta data-rh="true" name="description" content="Expressions, Sorts and Declarations"><meta data-rh="true" property="og:description" content="Expressions, Sorts and Declarations"><link data-rh="true" rel="icon" href="/z3guide/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://microsoft.github.io//z3guide/programming/Z3 Python - Readonly/advanced"><link data-rh="true" rel="alternate" href="https://microsoft.github.io//z3guide/programming/Z3 Python - Readonly/advanced" hreflang="en"><link data-rh="true" rel="alternate" href="https://microsoft.github.io//z3guide/programming/Z3 Python - Readonly/advanced" hreflang="x-default"><link rel="stylesheet" href="/z3guide/assets/css/styles.aad1eefe.css">
<link rel="preload" href="/z3guide/assets/js/runtime~main.6e957b6d.js" as="script">
<link rel="preload" href="/z3guide/assets/js/main.47293ec2.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/z3guide/"><b class="navbar__title text--truncate">Z3 Guide</b></a><a class="navbar__item navbar__link" href="/z3guide/docs/logic/intro">SMTLIB Tutorial</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/z3guide/programming/Z3 JavaScript Examples">Programming Z3</a><a class="navbar__item navbar__link" href="/z3guide/playground/Freeform Editing">Playground</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/microsoft/z3guide" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper mainWrapper_z2l0 docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/z3guide/programming/Z3 JavaScript Examples">Z3 JavaScript</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" href="/z3guide/programming/Z3 Python - Readonly/Introduction">Z3 Python - Readonly</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/z3guide/programming/Z3 Python - Readonly/Introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/z3guide/programming/Z3 Python - Readonly/advanced">Advanced Topics</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/z3guide/programming/Z3 Python - Readonly/Strategies">Strategies</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/z3guide/programming/Z3 Python - Readonly/Fixedpoints">Fixedpoints</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" href="/z3guide/programming/Example Programs/Cores and Satisfying Subsets">Example Programs</a></div></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/z3guide/programming/Parameters">Parameters</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/z3guide/programming/API Reference">API Reference</a></li></ul></nav></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/z3guide/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Z3 Python - Readonly</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Advanced Topics</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Advanced Topics</h1></header><h2 class="anchor anchorWithStickyNavbar_LWe7" id="expressions-sorts-and-declarations">Expressions, Sorts and Declarations<a class="hash-link" href="#expressions-sorts-and-declarations" title="Direct link to heading">​</a></h2><p>In Z3, expressions, sorts and declarations are called <em>ASTs</em>.
ASTs are directed acyclic graphs. Every expression has a sort (aka type).
The method <tt>sort()</tt> retrieves the sort of an expression.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The function <tt>eq(n1, n2)</tt> returns <tt>True</tt> if <tt>n1</tt>
and <tt>n2</tt> are the same AST. This is a structural test. </p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The method <tt>hash()</tt> returns a hashcode for an AST node.
If <tt>eq(n1, n2)</tt> returns <tt>True</tt>, then <tt>n1.hash()</tt>
is equal to <tt>n2.hash()</tt>. </p><div><div class="buttons_Vg2Y"></div><div></div></div><p>Z3 expressions can be divided in three basic groups: <strong>applications</strong>,
<strong>quantifiers</strong> and <strong>bounded/free variables</strong>.
Applications are all you need if your problems do not contain
universal/existential quantifiers. Although we say <tt>Int(&#x27;x&#x27;)</tt> is an
integer &quot;variable&quot;, it is technically an integer constant, and internally
is represented as a function application with <tt>0</tt> arguments.
Every application is associated with a <strong>declaration</strong> and contains </p><tt>0</tt> or more arguments. The method <tt>decl()</tt> returns the declaration associated with an application. The method <tt>num_args()</tt>returns the number of arguments of an application, and <tt>arg(i)</tt> one of the arguments. The function <tt>is_expr(n)</tt> returns <tt>True</tt>if <tt>n</tt> is an expression. Similarly <tt>is_app(n)</tt> (<tt>is_func_decl(n)</tt>) returns <tt>True</tt> if <tt>n</tt> is an application (declaration).<div><div class="buttons_Vg2Y"></div><div></div></div><p>Declarations have names, they are retrieved using the method <tt>name()</tt>.
A (function) declaration has an arity, a domain and range sorts.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The built-in declarations are identified using their <strong>kind</strong>. The kind
is retrieved using the method <tt>kind()</tt>. The complete list of built-in declarations
can be found in the file <tt>z3consts.py</tt> (<tt>z3_api.h</tt>) in the Z3 distribution.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The following example demonstrates how to substitute sub-expressions in Z3 expressions.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The function <tt>Const(name, sort)</tt> declares a constant (aka variable) of the given sort.
For example, the functions <tt>Int(name)</tt> and <tt>Real(name)</tt> are shorthands for</p><tt>Const(name, IntSort())</tt> and <tt>Const(name, RealSort())</tt>.<div><div class="buttons_Vg2Y"></div><div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="arrays">Arrays<a class="hash-link" href="#arrays" title="Direct link to heading">​</a></h2><p>As part of formulating a programme of a mathematical theory of computation
McCarthy proposed a <em>basic</em> theory of arrays as characterized by
the select-store axioms. The expression <tt>Select(a, i)</tt> returns
the value stored at position <tt>i</tt> of the array <tt>a</tt>;
and <tt>Store(a, i, v)</tt> returns a new array identical to <tt>a</tt>,
but on position <tt>i</tt> it contains the value <tt>v</tt>.
In Z3Py, we can also write <tt>Select(a, i)</tt> as <tt>a<!-- -->[i]</tt>.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>By default, Z3 assumes that arrays are extensional over select.
In other words, Z3 also enforces that if two arrays agree on all positions,
then the arrays are equal.</p><p>Z3 also contains various extensions
for operations on arrays that remain decidable and amenable
to efficient saturation procedures (here efficient means,
with an NP-complete satisfiability complexity).
We describe these extensions in the following using a collection of examples.
Additional background on these extensions is available in the
paper <a href="http://research.microsoft.com/en-us/um/people/leonardo/fmcad09.pdf" target="_blank" rel="noopener noreferrer">Generalized and Efficient Array Decision Procedures</a></p><p>Arrays in Z3 are used to model unbounded or very large arrays.
Arrays should not be used to model small finite collections of values.
It is usually much more efficient to create different variables using list comprehensions.</p><div><div class="buttons_Vg2Y"></div><div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="select-and-store">Select and Store<a class="hash-link" href="#select-and-store" title="Direct link to heading">​</a></h2><p>Let us first check a basic property of arrays.
Suppose <tt>A</tt> is an array of integers, then the constraints</p><tt>A[x] == x, Store(A, x, y) == A</tt>are satisfiable for an array that contains an index <tt>x</tt> that maps to <tt>x</tt>, and when <tt>x == y</tt>. We can solve these constraints.<div><div class="buttons_Vg2Y"></div><div></div></div><p>The interpretation/solution for array variables is very similar to the one used for functions.</p><p>The problem becomes unsatisfiable/infeasible if we add the constraint <tt>x != y</tt>.</p><div><div class="buttons_Vg2Y"></div><div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="constant-arrays">Constant arrays<a class="hash-link" href="#constant-arrays" title="Direct link to heading">​</a></h3><p>The array that maps all indices to some fixed value can be specified in Z3Py using the</p><tt>K(s, v)</tt> construct where <tt>s</tt> is a sort/type and <tt>v</tt> is an expression.<tt>K(s, v)</tt> returns a array that maps any value of <tt>s</tt> into <tt>v</tt>. The following example defines a constant array containing only ones.<div><div class="buttons_Vg2Y"></div><div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="datatypes">Datatypes<a class="hash-link" href="#datatypes" title="Direct link to heading">​</a></h2><p>Algebraic datatypes, known from programming languages such as ML,
offer a convenient way for specifying common data structures. Records
and tuples are special cases of algebraic datatypes, and so are
scalars (enumeration types). But algebraic datatypes are more
general. They can be used to specify finite lists, trees and other
recursive structures.</p><p>The following example demonstrates how to declare a List in Z3Py. It is
more verbose than using the SMT 2.0 front-end, but much simpler than using
the Z3 C API. It consists of two phases.
First, we have to declare the new datatype, its constructors and accessors.
The function <tt>Datatype(&#x27;List&#x27;)</tt> declares a &quot;placeholder&quot; that will
contain the constructors and accessors declarations. The method</p><tt>declare(cname, (aname, sort)+)</tt> declares a constructor named<tt>cname</tt> with the given accessors. Each accessor has an associated <tt>sort</tt>or a reference to the datatypes being declared. For example, <tt>declare(&#x27;cons&#x27;, (&#x27;car&#x27;, IntSort()), (&#x27;cdr&#x27;, List))</tt>declares the constructor named <tt>cons</tt> that builds a new <tt>List</tt>using an integer and a <tt>List</tt>. It also declares the accessors <tt>car</tt> and<tt>cdr</tt>. The accessor <tt>car</tt> extracts the integer of a <tt>cons</tt>cell, and <tt>cdr</tt> the list of a <tt>cons</tt> cell. After all constructors were declared, we use the method <tt>create()</tt> to create the actual datatype in Z3. Z3Py makes the new Z3 declarations and constants available as slots of the new object.<div><div class="buttons_Vg2Y"></div><div></div></div><p>The following example demonstrates how to define a Python function that
given a sort creates a list of the given sort. </p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The example above demonstrates that Z3 supports operator overloading.
There are several functions named <tt>cons</tt>, but they are different since they receive and/or
return values of different sorts.
Note that it is not necessary to use a different sort name for each instance of the sort
list. That is, the expression <tt>&#x27;List<em>of</em>%s&#x27; % sort.name()</tt> is not necessary, we
use it just to provide more meaningful names.</p><p>As described above enumeration types are a special case of algebraic datatypes.
The following example declares an enumeration type consisting of three values:</p><tt>red</tt>, <tt>green</tt> and <tt>blue</tt>.<div><div class="buttons_Vg2Y"></div><div></div></div><p>Z3Py also provides the following shorthand for declaring enumeration sorts.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>Mutually recursive datatypes can also be declared. The only difference is that we use
the function <tt>CreateDatatypes</tt> instead of the method <tt>create()</tt> to create
the mutually recursive datatypes.</p><div><div class="buttons_Vg2Y"></div><div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="uninterpreted-sorts">Uninterpreted Sorts<a class="hash-link" href="#uninterpreted-sorts" title="Direct link to heading">​</a></h2><p>Function and constant symbols in pure first-order logic are uninterpreted or free,
which means that no a priori interpretation is attached.
This is in contrast to arithmetic operators such as <tt>+</tt> and <tt>-</tt>
that have a fixed standard interpretation.
Uninterpreted functions and constants are maximally flexible;
they allow any interpretation that is consistent with the constraints over the function or constant.</p><p>To illustrate uninterpreted functions and constants let us introduce an (uninterpreted) sort <tt>A</tt>,
and the constants <tt>x</tt>, <tt>y</tt> ranging over <tt>A</tt>.
Finally let <tt>f</tt> be an uninterpreted function that takes one
argument of sort <tt>A</tt> and results in a value of sort <tt>A</tt>.
The example illustrates how one can force an interpretation where <tt>f</tt> applied twice to <tt>x</tt> results in <tt>x</tt> again,
but <tt>f</tt> applied once to <tt>x</tt> is different from <tt>x</tt>.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The resulting model introduces abstract values for the elements in <tt>A</tt>,
because the sort <tt>A</tt> is uninterpreted. The interpretation for <tt>f</tt> in the
model toggles between the two values for <tt>x</tt> and <tt>y</tt>, which are different.
The expression <tt>m<!-- -->[A]</tt> returns the interpretation (universe) for the uninterpreted sort <tt>A</tt>
in the model <tt>m</tt>. </p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="quantifiers">Quantifiers<a class="hash-link" href="#quantifiers" title="Direct link to heading">​</a></h2><p>Z3 is can solve quantifier-free problems containing arithmetic, bit-vector, Booleans,
arrays, functions and datatypes. Z3 also accepts and can work with formulas
that use quantifiers. It is no longer a decision procedure for
such formulas in general (and for good reasons, as there can be
no decision procedure for first-order logic).</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>Nevertheless, Z3 is often able to handle formulas involving
quantifiers. It uses several approaches to handle quantifiers.
The most prolific approach is using <em>pattern-based</em> quantifier
instantiation. This approach allows instantiating quantified formulas
with ground terms that appear in the current search context based
on <em>pattern annotations</em> on quantifiers.
Z3 also contains a model-based quantifier instantiation
component that uses a model construction to find good terms to instantiate
quantifiers with; and Z3 also handles many decidable fragments.</p><p>Note that in the previous example the constants <tt>x</tt>
and <tt>y</tt> were used to create quantified formulas.
This is a &quot;trick&quot; for simplifying the construction of quantified
formulas in Z3Py. Internally, these constants are replaced by
bounded variables. The next example demonstrates that. The method</p><tt>body()</tt> retrives the quantified expression. In the resultant formula the bounded variables are free. The function <tt>Var(index, sort)</tt> creates a bounded/free variable with the given index and sort. ```z3-python f = Function(&#x27;f&#x27;, IntSort(), IntSort(), IntSort()) x, y = Ints(&#x27;x y&#x27;) f = ForAll([x, y], f(x, y) == 0) print (f.body()) v1 = f.body().arg(0).arg(0) print (v1) print (eq(v1, Var(1, IntSort()))) ```<h3 class="anchor anchorWithStickyNavbar_LWe7" id="modeling-with-quantifiers">Modeling with Quantifiers<a class="hash-link" href="#modeling-with-quantifiers" title="Direct link to heading">​</a></h3><p>Suppose we want to model an object oriented type system with single inheritance.
We would need a predicate for sub-typing. Sub-typing should be a partial order,
and respect single inheritance. For some built-in type constructors,
such as for <tt>array_of</tt>, sub-typing should be monotone.</p><div><div class="buttons_Vg2Y"></div><div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="patterns">Patterns<a class="hash-link" href="#patterns" title="Direct link to heading">​</a></h3><p>The Stanford Pascal verifier and the subsequent Simplify theorem prover pioneered
the use of pattern-based quantifier instantiation.
The basic idea behind pattern-based quantifier instantiation is in a sense straight-forward:
Annotate a quantified formula using a pattern that contains all the bound variables.
So a pattern is an expression (that does not contain binding operations, such as quantifiers)
that contains variables bound by a quantifier. Then instantiate the quantifier whenever a term
that matches the pattern is created during search. This is a conceptually easy starting point,
but there are several subtleties that are important.</p><p>In the following example, the first two options make sure that Model-based quantifier instantiation engine is disabled.
We also annotate the quantified formula with the pattern <tt>f(g(x))</tt>.
Since there is no ground instance of this pattern, the quantifier is not instantiated, and
Z3 fails to show that the formula is unsatisfiable.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>When the more permissive pattern <tt>g(x)</tt> is used. Z3 proves the formula
to be unsatisfiable. More restrive patterns minimize the number of
instantiations (and potentially improve performance), but they may
also make Z3 &quot;less complete&quot;.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>Some patterns may also create long instantiation chains. Consider the following assertion.</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ForAll([x, y], Implies(subtype(x, y),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                       subtype(array_of(x), array_of(y))),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       patterns=[subtype(x, y)])</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The axiom gets instantiated whenever there is some ground term of the
form <tt>subtype(s, t)</tt>. The instantiation causes a fresh ground term</p><tt>subtype(array_of(s), array_of(t))</tt>, which enables a new instantiation. This undesirable situation is called a matching loop. Z3 uses many heuristics to break matching loops.<p>Before elaborating on the subtleties, we should address an important
first question. What defines the terms that are created during search?
In the context of most SMT solvers, and of the Simplify theorem
prover, terms exist as part of the input formula, they are of course
also created by instantiating quantifiers, but terms are also
implicitly created when equalities are asserted. The last point means
that terms are considered up to congruence and pattern matching takes
place modulo ground equalities. We call the matching problem
<strong>E-matching</strong>. For example, if we have the following equalities:</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The terms <tt>f(a)</tt> and <tt>f(g(b))</tt> are equal modulo the
equalities. The pattern <tt>f(g(x))</tt> can be matched and <tt>x</tt> bound to <tt>b</tt>
and the equality <tt>f(g(b)) ==  b</tt> is deduced.</p><p>While E-matching is an NP-complete problem, the main sources of overhead in larger verification
problems comes from matching thousands of patterns in the context of an evolving set of terms and
equalities. Z3 integrates an efficient E-matching engine using term indexing techniques.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="multi-patterns">Multi-patterns<a class="hash-link" href="#multi-patterns" title="Direct link to heading">​</a></h3><p>In some cases, there is no pattern that contains all bound variables
and does not contain interpreted symbols. In these cases, we use
multi-patterns. In the following example, the quantified formula
states that <tt>f</tt> is injective. This quantified formula is annotated with
the multi-pattern <tt>MultiPattern(f(x), f(y))</tt>.  </p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The quantified formula is instantiated for every pair of occurrences
of <tt>f</tt>. A simple trick allows formulating injectivity of <tt>f</tt> in such a way
that only a linear number of instantiations is required. The trick is
to realize that <tt>f</tt> is injective if and only if it has a partial
inverse.</p><div><div class="buttons_Vg2Y"></div><div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="other-attributes">Other attributes<a class="hash-link" href="#other-attributes" title="Direct link to heading">​</a></h3><p>In Z3Py, the following additional attributes are supported: <strong>qid</strong> (quantifier identifier
for debugging), <strong>weight</strong> (hint to the quantifier instantiation module: &quot;more weight equals less instances&quot;),
<strong>no_patterns</strong> (expressions that should not be used as patterns, <strong>skid</strong> (identifier
prefix used to create skolem constants/functions.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="multiple-solvers">Multiple Solvers<a class="hash-link" href="#multiple-solvers" title="Direct link to heading">​</a></h2><p>In Z3Py and Z3 multiple solvers can be simultaneously used.
It is also very easy to copy assertions/formulas from one solver to another.</p><div><div class="buttons_Vg2Y"></div><div></div></div><h2 class="anchor anchorWithStickyNavbar_LWe7" id="unsat-cores-and-soft-constraints">Unsat Cores and Soft Constraints<a class="hash-link" href="#unsat-cores-and-soft-constraints" title="Direct link to heading">​</a></h2><p>Z3Py also supports <em>unsat core extraction</em>. The basic idea is to use
<em>assumptions</em>, that is, auxiliary propositional variables that we want to track.
Assumptions are also available in the Z3 SMT 2.0 frontend, and in other Z3 front-ends.
They are used to extract unsatisfiable cores. They may be also used to &quot;retract&quot;
constraints. Note that, assumptions are not really <em>soft constraints</em>, but they can be used to implement them. </p><div><div class="buttons_Vg2Y"></div><div></div></div><p>The example above also shows that a Boolean variable (<tt>p1</tt>) can be used to track
more than one constraint. Note that Z3 does not guarantee that the unsat cores are minimal.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="formatter">Formatter<a class="hash-link" href="#formatter" title="Direct link to heading">​</a></h2><p>Z3Py uses a formatter (aka pretty printer) for displaying formulas, expressions, solvers, and other
Z3 objects. The formatter supports many configuration options.
The command <tt>set_option(html_mode=False)</tt> makes all formulas and expressions to be
displayed in Z3Py notation.</p><div><div class="buttons_Vg2Y"></div><div></div></div><p>By default, Z3Py will truncate the output if the object being displayed is too big.
Z3Py uses <!-- -->…<!-- --> to denote the output is truncated.
The following configuration options can be set to control the behavior of Z3Py&#x27;s formatter:</p><table><thead><tr><th>Parameter</th><th>Description</th></tr></thead><tbody><tr><td>max_depth</td><td>Maximal expression depth. Deep expressions are replaced with <!-- -->…<!-- -->.</td></tr><tr><td>max_args</td><td>Maximal number of arguments to display per node.</td></tr><tr><td>rational_to_decimal</td><td>Display rationals as decimals if True.</td></tr><tr><td>precision</td><td>Maximal number of decimal places for numbers being displayed in decimal notation.</td></tr><tr><td>max_lines</td><td>Maximal number of lines to be displayed.</td></tr><tr><td>max_width</td><td>Maximal line width (this is a suggestion to Z3Py).</td></tr><tr><td>max_indent</td><td>Maximal indentation.</td></tr></tbody></table></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/microsoft/z3guide/tree/main/website/docs-programming/02 - Z3 Python - Readonly/02 - advanced.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vwxv"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/z3guide/programming/Z3 Python - Readonly/Introduction"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Introduction</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/z3guide/programming/Z3 Python - Readonly/Strategies"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Strategies</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#expressions-sorts-and-declarations" class="table-of-contents__link toc-highlight">Expressions, Sorts and Declarations</a></li><li><a href="#arrays" class="table-of-contents__link toc-highlight">Arrays</a></li><li><a href="#select-and-store" class="table-of-contents__link toc-highlight">Select and Store</a><ul><li><a href="#constant-arrays" class="table-of-contents__link toc-highlight">Constant arrays</a></li></ul></li><li><a href="#datatypes" class="table-of-contents__link toc-highlight">Datatypes</a></li><li><a href="#uninterpreted-sorts" class="table-of-contents__link toc-highlight">Uninterpreted Sorts</a></li><li><a href="#quantifiers" class="table-of-contents__link toc-highlight">Quantifiers</a><ul><li><a href="#modeling-with-quantifiers" class="table-of-contents__link toc-highlight">Modeling with Quantifiers</a></li><li><a href="#patterns" class="table-of-contents__link toc-highlight">Patterns</a></li><li><a href="#multi-patterns" class="table-of-contents__link toc-highlight">Multi-patterns</a></li><li><a href="#other-attributes" class="table-of-contents__link toc-highlight">Other attributes</a></li></ul></li><li><a href="#multiple-solvers" class="table-of-contents__link toc-highlight">Multiple Solvers</a></li><li><a href="#unsat-cores-and-soft-constraints" class="table-of-contents__link toc-highlight">Unsat Cores and Soft Constraints</a></li><li><a href="#formatter" class="table-of-contents__link toc-highlight">Formatter</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">More Z3</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://z3prover.github.io/papers/programmingz3.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">Programming Z3 in Python<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/Z3Prover/z3" target="_blank" rel="noopener noreferrer" class="footer__link-item">Z3 on GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Z3 Material</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://z3prover.github.io/api/html/index.html" target="_blank" rel="noopener noreferrer" class="footer__link-item">API</a></li><li class="footer__item"><a href="https://z3prover.github.io/slides" target="_blank" rel="noopener noreferrer" class="footer__link-item">Slides<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/z3prover/z3/wiki" target="_blank" rel="noopener noreferrer" class="footer__link-item">Wiki<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Stay Connected</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/microsoft/z3guide" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://twitter.com/RiSE_MSR" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.microsoft.com/en-us/research/group/research-software-engineering-rise/" target="_blank" rel="noopener noreferrer" class="footer__link-item">RiSE @ MSR<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://go.microsoft.com/fwlink/?LinkId=521839" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy &amp; Cookies<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/copyright" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms of Use<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://www.microsoft.com/en-us/legal/intellectualproperty/trademarks/usage/general" target="_blank" rel="noopener noreferrer" class="footer__link-item">Trademarks<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright"><a href="https://github.com/microsoft/z3guide/commit/8de5961fc9c1840285af6b4ef04044bce959289e" target="_blank" rel="noopener noreferrer">8de5961f</a> | Copyright © 2022 Microsoft Corporation.</div></div></div></footer></div>
<script src="/z3guide/assets/js/runtime~main.6e957b6d.js"></script>
<script src="/z3guide/assets/js/main.47293ec2.js"></script>
</body>
</html>